# Arduino-AD-Multichannel-Multitasking-Interrupt

(C) 2019 Dipl. Phys. Helmut Weber<br>
* 
* Reading AD-Valures, which are generated by interrupts<br>
* ATMega328p: UNO, NANO, ...<br>
* 
*
* Sketch uses 3872 bytes (12%) of program storage space. Maximum is 30720 bytes.
* Global variables use 388 bytes (18%) of dynamic memory, leaving 1660 bytes for local variables. Maximum is 2048 bytes.
* 
* <h3>
* Introduction
* </h3>
*
* Realtime Operating systems are the prefered tool for most measurements.<br>
* ChibiOS and derivatives are running on the Arduino UNO.<br>
* But sometimes a TickTime of 1 ms is too long.<br>
* 
*  <h3>
* Interrupts
* </h3>
* Here I show another approach using Interrupts.
* Three curves are red from the AD-converter using AD-Interrupt-Conversion-Ready<br>
* About 6000 conversions per second are done.<br>
* The red values are filtered an may be displayed using "Serial Plotter"<br>
* 
*  <h3>
* Multitasking
* </h3>
* Besides "loop" 2 tasks are running in the backgrund"<br>
* One of them precisly ever 1 ms !
* 
* 
*  <h3>
* Filter
* </h3>
* AD-Values for CHNUM channel are read using AD-Ready-Interrupts.
* One Channel after the other is read starting with channel 0 again.
* 
* This is done in the background without any intervention of the LOOP
* 
* The values are averaged for IRQ_SAMPLES  samples
* 
* This is the code for averaging:
*    > avv=(float)analogVal;    <br>
*    > av[Channel] = (Alpha[Channel]*oldVal[Channel]) + ((1-Alpha[Channel])*avv);    <br>
*    > oldVal[Channel]=av[Channel];    <br>
* 
* The sense is to get most samples possible, build an average over IRQ_SAMPLES value 
* and set the IrqReadyFlag.
* Then the Measurement is stopped and the "Busy" Flag is set.
* 
* LOOP or any other function has to read (and print/ plot) the values.
* 
* After that the next points will be generated in the background again with:
* 
*   > IrqReadyFlag = 0;    <br>
*   > Busy = false;    <br>
*   > ADCSRA |= B01000000; // Start next conversion    <br>
* 
*  <h3>
* Example-HEART-BEAT
* </h3>
* Here is an example of a HEART-BEAT-Sensor. 
* 
* \image html Demo.jpg
* \image latex Demo.jpg
*
* Blue - original 
* 
* Green - soft filtered
* 
* Red - hard filtered<br
* 
* The channels got an offset for better display.
* 
* Filtereing implies a phase shift !
* 
*  <h3>
* Timing
* </h3>
* \image html Timing.jpg
* \image latex Timing.jpg
* 
* We get about 6000 (filtered) samples per second - 2000 per channel 
* 
* - with 10 IRQ_SAMPLES there are 200 Time Points per second (180 with Serial.print)
* 
* Enough to show the details of HEART-BEAT
* 
* The output in LOOP needs 1,6 ms every 5,6 ms for a Time Point. 
* 
* There is plenty of room to do other things in LOOP !
* 
* * Build pdf: in latex: pdflatex refman
* 
* @author Helmut Weber
*/ 
